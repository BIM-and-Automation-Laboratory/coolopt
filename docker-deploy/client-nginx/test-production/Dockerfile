# Stage 1: Build
FROM node:12 as build

WORKDIR /app

COPY ./client/package.json .
RUN npm install
COPY ./client/ .

ARG REACT_APP_GRAPHQL_URI
ARG LOCAL_GQL_PROXY
ARG REACT_APP_AUTH0_DOMAIN
ARG REACT_APP_AUTH0_CLIENT_ID
ARG REACT_APP_AUTH0_AUDIENCE
ARG REACT_APP_AUTH0_ROLES_NAMESPACE

ENV REACT_APP_GRAPHQL_URI=${REACT_APP_GRAPHQL_URI}
ENV LOCAL_GQL_PROXY=${LOCAL_GQL_PROXY}
ENV REACT_APP_AUTH0_DOMAIN=${REACT_APP_AUTH0_DOMAIN}
ENV REACT_APP_AUTH0_CLIENT_ID=${REACT_APP_AUTH0_CLIENT_ID}
ENV REACT_APP_AUTH0_AUDIENCE=${REACT_APP_AUTH0_AUDIENCE}
ENV REACT_APP_AUTH0_ROLES_NAMESPACE=${REACT_APP_AUTH0_ROLES_NAMESPACE}

RUN npm run build

# Stage 2: Create NGINX server
FROM nginx:stable-alpine
COPY --from=build /app/build /usr/share/nginx/html
CMD ["nginx", "-g", "daemon off;"]